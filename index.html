<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Kamera ‚Üí Przytnij ‚Üí Wy≈õlij do n8n</title>

  <!-- Cropper.js -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bar-bg:#111;
      --bar-fg:#f5f5f5;
      --accent:#ffd54a;
      --muted:#888;
      --border:#2a2a2a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: #000;
      color: #ddd;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      line-height: 1.4;
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-height: 100svh;
    }

    /* G√≥rny pasek narzƒôdzi */
    .toolbar {
      display: flex;
      align-items: center;
      gap: .75rem;
      padding: .6rem .8rem;
      background: var(--bar-bg);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 5;
    }
    .spacer { flex: 1; }
    .btn {
      background: #1a1a1a;
      color: var(--bar-fg);
      border: 1px solid var(--border);
      padding: .5rem .8rem;
      border-radius: .6rem;
      font-size: .95rem;
      cursor: pointer;
      transition: transform .06s ease;
    }
    .btn:hover { background:#222; }
    .btn:active { transform: scale(0.98); }
    .btn.primary { background: var(--accent); color: #222; border-color: #e6c23d; font-weight: 600; }
    .btn.ghost { background: transparent; }
    .btn:disabled { opacity: .5; cursor: not-allowed; }

    /* G≈Ç√≥wna scena */
    .stage {
      width: min(100vw, 1100px);
      margin: 0 auto;
      padding: 1rem;
      display: grid;
      gap: 1rem;
      place-items: center;
    }
    video, img {
      max-width: 100%;
      max-height: calc(100svh - 220px);
      width: auto;
      height: auto;
      display: block;
      border: 1px solid #222;
      background: #000;
    }

    /* Dolny panel (obrot + akcje) */
    .bottom {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 1rem;
      align-items: center;
      padding: .8rem 1rem 1.2rem;
      background: #0b0b0b;
      border-top: 1px solid var(--border);
    }
    .control {
      color: #ccc;
      display: flex;
      align-items: center;
      gap: .75rem;
    }
    input[type="range"] {
      width: min(70vw, 520px);
      accent-color: var(--accent);
    }
    .hint { color: var(--muted); font-size: .9rem; }

    /* Styl croppera ‚Äì bia≈Çe linie/uchwyty jak w systemowych edytorach */
    .cropper-view-box,
    .cropper-face { border-radius: .2rem; }
    .cropper-view-box { outline: 2px solid #fff; outline-color: rgba(255,255,255,.9); }
    .cropper-line { background-color: rgba(255,255,255,.9); }
    .cropper-point { width: 10px; height: 10px; background: #fff; opacity: 1; }
    .cropper-point.point-se,
    .cropper-point.point-sw,
    .cropper-point.point-ne,
    .cropper-point.point-nw { width: 12px; height: 12px; }

    /* Ukryty canvas do konwersji blob√≥w */
    canvas { display: none; }
  </style>
</head>
<body>

  <!-- Pasek narzƒôdzi -->
  <div class="toolbar">
    <button id="btnCancel" class="btn ghost" disabled>Cancel</button>
    <div class="spacer"></div>
    <button id="btnRotateLeft" class="btn" disabled>Rotate left</button>
    <button id="btnFlipH" class="btn" disabled>Flip horizontal</button>
    <button id="btnFlipV" class="btn" disabled>Flip vertical</button>
    <button id="btnDone" class="btn primary" disabled>Done</button>
  </div>

  <!-- Scena -->
  <main class="stage">
    <video id="video" autoplay playsinline></video>
    <img id="photo" alt="podglƒÖd" style="display:none;" />
    <canvas id="work"></canvas>

    <div class="hint" id="hintCam">Pozw√≥l na dostƒôp do kamery, potem kliknij ‚ÄûZr√≥b zdjƒôcie‚Äù.</div>
    <button id="btnCapture" class="btn primary">üì∏ Zr√≥b zdjƒôcie</button>

    <button id="btnSend" class="btn" disabled>üì§ Wy≈õlij do n8n</button>
  </main>

  <!-- Dolny panel -->
  <div class="bottom">
    <div class="control">
      <label for="rotateRange">Obr√≥t</label>
      <input id="rotateRange" type="range" min="-45" max="45" step="1" value="0" disabled />
      <span id="deg">0¬∞</span>
    </div>
    <div class="hint">PrzeciƒÖgnij krawƒôdzie, aby kadr by≈Ç idealny. U≈ºyj suwaka, aby delikatnie obr√≥ciƒá.</div>
  </div>

  <script>
    const video = document.getElementById('video');
    const img = document.getElementById('photo');
    const canvas = document.getElementById('work');

    const btnCapture = document.getElementById('btnCapture');
    const btnSend = document.getElementById('btnSend');

    const btnCancel = document.getElementById('btnCancel');
    const btnRotateLeft = document.getElementById('btnRotateLeft');
    const btnFlipH = document.getElementById('btnFlipH');
    const btnFlipV = document.getElementById('btnFlipV');
    const btnDone = document.getElementById('btnDone');

    const rotateRange = document.getElementById('rotateRange');
    const degLabel = document.getElementById('deg');
    const hintCam = document.getElementById('hintCam');

    let cropper = null;
    let scaleX = 1, scaleY = 1;
    let finalBlob = null;

    // 1) Kamera
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => { video.srcObject = stream; })
      .catch(err => {
        hintCam.textContent = 'B≈ÇƒÖd dostƒôpu do kamery: ' + err;
      });

    // 2) Zr√≥b zdjƒôcie ‚Üí poka≈º w tym samym <img> i od razu w≈ÇƒÖcz cropper
    btnCapture.addEventListener('click', () => {
      const w = video.videoWidth;
      const h = video.videoHeight;
      if (!w || !h) return;

      canvas.width = w;
      canvas.height = h;
      canvas.getContext('2d').drawImage(video, 0, 0, w, h);
      img.src = canvas.toDataURL('image/jpeg', 0.92);

      // prze≈ÇƒÖcz widoki
      img.style.display = 'block';
      video.style.display = 'none';
      hintCam.style.display = 'none';
      enableEditUI(true);
      startCropper();
    });

    // 3) Operacje edycyjne
    function startCropper() {
      if (cropper) cropper.destroy();
      scaleX = 1; scaleY = 1;
      rotateRange.value = 0; degLabel.textContent = '0¬∞';

      cropper = new Cropper(img, {
        viewMode: 1,               // nie wychod≈∫ poza obraz
        dragMode: 'move',
        background: false,
        autoCrop: true,
        autoCropArea: 0.85,
        modal: true,
        guides: true,
        movable: true,
        zoomable: true,
        scalable: true,
        rotatable: true,
      });

      // Suwak obrotu ‚Äì miƒôkki obr√≥t
      rotateRange.addEventListener('input', onRotateInput);
    }

    function onRotateInput() {
      if (!cropper) return;
      const deg = parseInt(rotateRange.value, 10) || 0;
      degLabel.textContent = deg + '¬∞';
      cropper.rotateTo(deg);
    }

    btnRotateLeft.addEventListener('click', () => {
      if (!cropper) return;
      // skokowy obr√≥t o -90¬∞
      const cur = parseInt(rotateRange.value, 10) || 0;
      const next = cur - 90;
      rotateRange.value = next;
      degLabel.textContent = next + '¬∞';
      cropper.rotateTo(next);
    });

    btnFlipH.addEventListener('click', () => {
      if (!cropper) return;
      scaleX = scaleX * -1;
      cropper.scaleX(scaleX);
    });

    btnFlipV.addEventListener('click', () => {
      if (!cropper) return;
      scaleY = scaleY * -1;
      cropper.scaleY(scaleY);
    });

    btnCancel.addEventListener('click', () => {
      // wr√≥ƒá do kamery i anuluj edycjƒô
      if (cropper) { cropper.destroy(); cropper = null; }
      img.style.display = 'none';
      video.style.display = 'block';
      enableEditUI(false);
      btnSend.disabled = true;
      finalBlob = null;
      rotateRange.removeEventListener('input', onRotateInput);
      rotateRange.value = 0; degLabel.textContent = '0¬∞';
    });

    btnDone.addEventListener('click', () => {
      if (!cropper) return;

      // pobierz przyciƒôty canvas i PODMIE≈É zawarto≈õƒá TEGO SAMEGO <img>
      const out = cropper.getCroppedCanvas({ imageSmoothingQuality: 'high' });
      out.toBlob(blob => {
        finalBlob = blob;
        img.src = out.toDataURL('image/jpeg', 0.92);
        // po zatwierdzeniu ‚Äì ko≈Ñczymy tryb edycji, ale zostawiamy obraz
        cropper.destroy(); cropper = null;
        enableEditUI(false);
        btnSend.disabled = false;
        rotateRange.removeEventListener('input', onRotateInput);
      }, 'image/jpeg', 0.92);
    });

    function enableEditUI(on) {
      btnCancel.disabled = !on;
      btnRotateLeft.disabled = !on;
      btnFlipH.disabled = !on;
      btnFlipV.disabled = !on;
      btnDone.disabled = !on;
      rotateRange.disabled = !on;
      // podczas edycji nie mo≈ºna ‚ÄûZr√≥b zdjƒôcie‚Äù
      btnCapture.disabled = on;
    }

    // 4) Wy≈õlij do n8n
    btnSend.addEventListener('click', async () => {
      try {
        const blob = finalBlob || (await new Promise(res => {
          // awaryjnie: je≈õli kto≈õ kliknie ‚ÄûWy≈õlij‚Äù bez Done, wy≈õlij aktualny kadr
          const c = cropper ? cropper.getCroppedCanvas() : null;
          (c || canvas).toBlob(res, 'image/jpeg', 0.92);
        }));

        const fd = new FormData();
        fd.append('file', blob, 'photo.jpg');

        const resp = await fetch('https://twoj-n8n-webhook.url/webhook-test', {
          method: 'POST',
          body: fd
        });

        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        alert('Wys≈Çano zdjƒôcie do n8n üéâ');
      } catch (e) {
        alert('B≈ÇƒÖd wysy≈Çania: ' + e.message);
      }
    });
  </script>
</body>
</html>
